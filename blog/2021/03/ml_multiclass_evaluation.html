<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no"/>
        <title>Working in Progress</title>
        <link rel="stylesheet" href="/css/main.css"/>
        <link rel="stylesheet" href="/css/zenburn.css"/>
        
        
    </head><body class="is-preload">
        <div id="wrapper">
            <div id="main">
                <div class="inner">
                    <header id="header">
                        <a href="/index.html" class="logo">
                            <strong>
                                WORKING IN PROGRESS
                            </strong> - POST
                        </a><ul class="icons">
                            <li>
                                <a href="/feed.xml" class="icon fa-rss">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://twitter.com/marioggar" class="icon fa-twitter">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://github.com/mariogarcia" class="icon fa-github">
                                    <span class="label">
                                        Github
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </header><section><header class="main"><div class="metadata"><em class="fa fa-calendar-o"></em><b>2021-03-26</b></div><h1>Model Evaluation: Multiclass evaluation</h1></header><yieldScaped><div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="/img/2021/03/ml_confusion_matrix/header.png" alt="ConfusionAndMatrix" width="100%">
</div>
</div>
<div class="paragraph">
<p>So far I&#8217;ve been evaluating binary classifiers using different techniques such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="/blog/2021/03/ml_confusion_matrix.html">Confusion Matrices</a></p>
</li>
<li>
<p><a href="/blog/2021/03/ml_decision_functions.html">Decision Functions</a></p>
</li>
<li>
<p><a href="/blog/2021/03/ml_decision_functions.html">Precision-Recall Curves</a></p>
</li>
<li>
<p><a href="/blog/2021/03/ml_roc_curve.html">ROC Curves and AUC</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This time, I&#8217;m dealing with a <strong>multiclass classification problem</strong>, and I&#8217;d like to apply some of these techniques too.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the_dataset">The dataset</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;m using the <a href="https://archive.ics.uci.edu/ml/datasets/Contraceptive+Method+Choice">Contraceptive Method Choice Data Set</a> from the
<a href="https://archive.ics.uci.edu/ml/datasets.php">UCI machine learning dataset site</a>. This dataset is a subset of the 1987 National Indonesia Contraceptive Prevalence Survey. There are three possible target classes values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>1</strong>: No contraceptive method used</p>
</li>
<li>
<p><strong>2</strong>: Long-Term contraceptive method used</p>
</li>
<li>
<p><strong>3</strong>: Short-Term contraceptive method used</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparing_the_data">Preparing the data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These are the steps I followed prior to build any model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Loading data</strong> from csv and <strong>naming columns meaningfully</strong></p>
</li>
<li>
<p><strong>Separating possible features</strong> from target multiclass column</p>
</li>
<li>
<p>Preprocessing features to <strong>normalize scales</strong></p>
</li>
<li>
<p><strong>Oversampling</strong> under-represented classes <strong>to avoid imbalance</strong></p>
</li>
<li>
<p>Doing <strong>feature selection</strong></p>
</li>
<li>
<p>Creating <strong>training/test datasets</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m going to avoid copy/pasting that part here for the shake of briefness. You can check the <a href="/files/2021/03/ml_multiclass_evaluation/contraceptive.ipynb">Jupyter Notebook source</a> for this entry any time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building_evaluating_models">Building &amp; Evaluating models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this step I did a small pipeline that took a list of possible classifiers, each one with a set of possible parameters, and it looked for the best outcome for a given scoring strategy. A couple of things to keep in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Not every <strong>scoring strategy</strong> works for a multiclass classification</p>
</li>
<li>
<p>I used <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html">GridSearchCV</a> to do cross validation with the different classifiers/parameters</p>
</li>
<li>
<p>I did a <strong>stratified cross validation</strong> (5 segments)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, the classifiers, and their possible parameters:</p>
</div>
<div class="listingblock">
<div class="title">classifiers</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from sklearn.svm import SVC
from sklearn.linear_model import LogisticRegression
from sklearn.neighbors import KNeighborsClassifier
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.ensemble import AdaBoostClassifier
from sklearn.svm import LinearSVC

classifiers = [
    {
        'classifier': SVC(),
        'params': {
            'C': [1, 5, 10, 20, 30, 40]
        }
    },
    {
        'classifier': LogisticRegression(),
        'params': {
            'C': [1, 5, 10, 20, 30, 40],
            'solver': ['newton-cg', 'saga']
        }
    },
    {
        'classifier': KNeighborsClassifier(),
        'params': {
            'n_neighbors': [5, 10, 15, 20]
        }
    },
    {
        'classifier': DecisionTreeClassifier(),
        'params': {
            'max_depth': [3, 4, 5, 6]
        }
    },
    {
        'classifier': RandomForestClassifier(),
        'params': {
            'max_depth': [3, 4, 5, 6]
        }
    },
    {
        'classifier': AdaBoostClassifier(),
        'params': {
            'n_estimators': [50, 60, 75, 100]
        }
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every entry of this list is going to be passed (along with the (X,y) data) to the following function in order to extract the best parameters to used to reach the best performance out of the classifier:</p>
</div>
<div class="listingblock">
<div class="title">extract the best parameters</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from sklearn.model_selection import GridSearchCV

def resolve_best_params(classifier_entry, X_param, y_param):
    clsf_instance = classifier_entry['classifier']
    clsf_params   = classifier_entry['params']
    grid_search   = GridSearchCV(
        clsf_instance,
        cv=5,
        param_grid=clsf_params,
        scoring='precision_macro')
    grid_result   = grid_search.fit(X_param, y_param)

    return grid_result.best_params_</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case I&#8217;ve used the <strong>precision_macro</strong> strategy but you can use <a href="https://scikit-learn.org/stable/modules/model_evaluation.html#scoring-parameter">any strategy found here</a> as long as it is <strong>compatible with a multiclass</strong> situation.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Macro vs Micro scoring</div>
<div class="paragraph">
<p>When using <strong>macro scoring all classes have equal weight</strong> when calculating the score whereas <strong>micro scoring means that all instances have equal weight</strong> in the final score. You can use both for different purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you&#8217;d like to measure the metric (precision, recall&#8230;&#8203;) toward the classes with <strong>larger amount</strong> of samples, <strong>use micro</strong></p>
</li>
<li>
<p>If you&#8217;d like to measure the metric (precision, recall&#8230;&#8203;) toward the classes with <strong>smaller amount</strong> of samples, <strong>use macro</strong></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="confusion_matrices">Confusion Matrices</h3>
<div class="paragraph">
<p>Now that we have the classifiers and the function extracting the best parameters, I&#8217;m comparing the classifiers using <strong>confusion matrices</strong>. Unlike the binary classification, in a multiclass classification, the matrix grows to <strong>N x N</strong> where N is the number of possible target classes. So in this particular scenario we will be dealing with 3x3 matrices.</p>
</div>
<div class="listingblock">
<div class="title">creating confusion matrices</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from sklearn.metrics import confusion_matrix
import seaborn as sns
import matplotlib.pyplot as plt

f, ax = plt.subplots(2, 3, figsize=(15, 10))
cols  = 0
rows  = 0

for clsf in classifiers:
    best_params = resolve_best_params(clsf, X, y)
    classifier  = clsf['classifier'].set_params(**best_params).fit(X, y)
    clsf_name   = type(classifier).__name__

    y_predicted = classifier.predict(X_test)
    matrix      = confusion_matrix(y_test, y_predicted)
    dataframe   = pd.DataFrame(matrix, index=[1, 2, 3], columns=[1, 2, 3])

    ax[rows, cols].title.set_text(clsf_name)
    sns.heatmap(dataframe, cbar=False, square=True, annot=True, fmt='g',ax=ax[rows, cols])
    if cols &lt; 2:
        cols += 1
    else:
        cols = 0
        rows +=1

plt.show()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how it looks like:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/2021/03/ml_multiclass_evaluation/confusion_matrices.png" alt="Confusion Matrices" width="60%">
</div>
</div>
<div class="paragraph">
<p>To interpret these confusion matrices you need to <strong>remember that the True Positive matches for target classes are the ones in the main diagonal</strong>, and the rest are false positives (horizontally) or false negatives (vertically). Lets see an specific example. Lets focus on the <strong>target class 1</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/2021/03/ml_multiclass_evaluation/confusion_matrix.png" alt="Multiclass Confusion Matrix" width="25%">
</div>
</div>
<div class="paragraph">
<p><strong>If we focus on the first row</strong>, we see that of 122 times the classifier says it&#8217;s 1, it is indeed 1, then 22 times says it&#8217;s 1 when it is really 2 and 17 times says it is 1 when it turns out it was a 3.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/2021/03/ml_multiclass_evaluation/confusion_matrix_row.png" alt="Multiclass Confusion Matrix" width="25%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>122 TP</strong> (true positives)</p>
</li>
<li>
<p><strong>22 + 17 FP</strong> (false positives).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>If we focus on the first column</strong>, we see that in 122 ocassions says it is 1 correctly, then 7 times says it&#8217;s 1 when it should be 2, and 14 times says it&#8217;s 1 when it should be 3.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/2021/03/ml_multiclass_evaluation/confusion_matrix_column.png" alt="Multiclass Confusion Matrix" width="20%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>122 TP</strong></p>
</li>
<li>
<p><strong>21 FN</strong> (7 + 14)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="classification_report">Classification Report</h3>
<div class="paragraph">
<p>We can also use the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.classification_report.html">classification_report</a> function to show the scoring of the most important metrics. Follow up I&#8217;m looping over the list of classifiers to get the classification report of each one of them:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Remember that the cross validation process has been optimized towards precision with macro average meaning that every class have the same weight when calculating the precision.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">multiclass classification report</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from sklearn.metrics import classification_report

for clsf in classifiers:
    best_params   = resolve_best_params(clsf, X, y)
    classifier    = clsf['classifier'].set_params(**best_params).fit(X, y)
    clsf_name     = type(classifier).__name__
    y_predicted   = classifier.predict(X_test)
    report_result = classification_report(y_test, y_predicted)

    print()
    print("{} -- {}".format(clsf_name, best_params))
    print('-------------------------------------------------------')
    print()
    print(report_result)
    print()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s part of the output of the classification report. We can see how it has the scores for precision, recall, and f1-score for every class, and at the bottom it measures the accuracy for both micro and macro avg.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/2021/03/ml_multiclass_evaluation/classification_report_sample.png" alt="Classification Report Sample" width="50%">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://archive.ics.uci.edu/ml/datasets/Contraceptive+Method+Choice">Contraceptive Methods Dataset</a>: from ICU dataset repository site</p>
</li>
<li>
<p><a href="/files/2021/03/ml_multiclass_evaluation/contraceptive.ipynb">contraceptive.ipynb</a>: Article Jupyter&#8217;s Notebook</p>
</li>
<li>
<p><a href="/blog/2021/02/ml_imbalanced_classes.html">Imbalanced Classes</a>: Article I did about dealing with imbalanced classes using imblearn</p>
</li>
</ul>
</div>
</div>
</div></yieldScaped></section>
                </div>
            </div><div id="sidebar">
                <div class="inner">
                    <!--Menu--><nav id="menu">
                        <header class="major">
                            <h2>Menu</h2>
                        </header><ul>
                            <li>
                                <a href="/index.html">Latests entries</a>
                            </li><li>
                                <a href="/archive.html">Archive</a>
                            </li><li>
                                <a href="/stats.html">Statistics</a>
                            </li><li>
                                <a href="/about.html">About</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div><script src="/js/jquery.min.js"></script>
            <script src="/js/browser.min.js"></script>
            <script src="/js/breakpoints.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/highlight.pack.js"></script>
            <script type="text/javascript">
                
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    
            </script>
        </div>
    </body>
</html>
