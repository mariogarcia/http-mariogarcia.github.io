<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no"/>
        <title>Working in Progress</title>
        <link rel="stylesheet" href="/css/main.css"/>
        <link rel="stylesheet" href="/css/zenburn.css"/>
        
        
    </head><body class="is-preload">
        <div id="wrapper">
            <div id="main">
                <div class="inner">
                    <header id="header">
                        <a href="/index.html" class="logo">
                            <strong>
                                WORKING IN PROGRESS
                            </strong> - POST
                        </a><ul class="icons">
                            <li>
                                <a href="/feed.xml" class="icon fa-rss">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://twitter.com/marioggar" class="icon fa-twitter">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://github.com/mariogarcia" class="icon fa-github">
                                    <span class="label">
                                        Github
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </header><section><header class="main"><div class="metadata"><em class="fa fa-calendar-o"></em><b>2021-03-16</b></div><h1>Event Sourcing 101</h1></header><yieldScaped><div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="/img/2021/03/event_sourcing/event_sourcing.png" alt="event sourcing" width="100%">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_is_event_sourcing">What is event sourcing ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As opposed to store the last state of your data, event sourcing <strong>stores every and each change your system had in the form of events</strong>. And <strong>event</strong> is just a piece of information with some contraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Contains only the fragment of your system that has changed</strong>. Usually called <strong>"a fact"</strong>.</p>
</li>
<li>
<p>It will <strong>never ever change</strong></p>
</li>
<li>
<p>It should have some information that determines <strong>when it happened</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Imagine the typical bank application where you can see your balance. The bank doesn&#8217;t stores only the balance, it turns out the bank stores every single deposit, withdrawal, commission&#8230;&#8203;etc and when you ask for your balance, it <strong>adds up all the previous events</strong> that happened to your account and only shows you the computed result or <strong>the projection of these events</strong>. Imagine a given&#8217;s account transactions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Bank transactions</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ACCOUNT_ID</th>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">AMOUNT</th>
<th class="tableblock halign-left valign-top">DATE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEPOSIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:23:23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITHDRAWAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:24:23</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And the <strong>current state</strong> of the account, which <strong>is a summary, projection or aggregate of what has happened until now</strong>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Account Projection</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ACCOUNT_ID</th>
<th class="tableblock halign-left valign-top">HOLDER NAME</th>
<th class="tableblock halign-left valign-top">BALANCE</th>
<th class="tableblock halign-left valign-top">DATE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Silvester Stallone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:24:23</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>That type of behavior allows the bank to be able to answer <strong>WHY</strong> your balance is 0 EUR and not 20000 EUR. They can show you all
the facts that lead to that state of your balance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>This balance projection normally is materialized at some point</strong> to avoid querying the event store every time</p>
</li>
<li>
<p><strong>The event store notifies when a new event has happened</strong> in order to take action by interested parties, like updating the projection tables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lets review the most important features of event-sourcing.</p>
</div>
<div class="sect2">
<h3 id="temporal_queries">Temporal queries</h3>
<div class="paragraph">
<p>Storing events with a timestamp allows the system to aggregate all events until a given moment of time to see the state
of the system at that moment. That is very valuable for different scenarios:</p>
</div>
<div class="paragraph">
<p><span class="image right"><img src="/img/2021/03/event_sourcing/temporal_query.png" alt="temporal query" width="30%"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Auditing</strong>: We need to know who did what at a given date</p>
</li>
<li>
<p><strong>Forensic Analysis</strong>: something went wrong with the system and we need to figure out why</p>
</li>
<li>
<p><strong>UX review</strong>: UX wanted to know how the system looked like at a given point in time</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="complete_rebuild">Complete rebuild</h3>
<div class="paragraph">
<p>As I mentioned earlier, you don&#8217;t normally aggregate all events to show a client&#8217;s current balance. You create a projection
of some of the events, in another table for faster access. That could give you a faster response to the client. But something can go wrong with your data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some of your derived <strong>data is lost</strong></p>
</li>
<li>
<p>The process that created the balance projection <strong>messed some data</strong>.</p>
</li>
<li>
<p><strong>You need to change the schema</strong> of your projection table</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image left"><img src="/img/2021/03/event_sourcing/complete_rebuild.png" alt="temporal query" width="30%"></span></p>
</div>
<div class="paragraph">
<p>In in this type of scenarios where an event-store can give you the opportunity to read all the events that lead to the current state and rebuild your system state.</p>
</div>
</div>
<div class="sect2">
<h3 id="data_freedomkind_of">Data freedom&#8230;&#8203;kind of</h3>
<div class="paragraph">
<p>Well it has to do with the previous feature. <strong>If you need to change the schema of your projections</strong>, instead of keeping
a migration log of those changes, you can just delete the projection table, create a new one, and then read the event store
again to populate the new table.</p>
</div>
<div class="paragraph">
<p>This feature <strong>can give you a lot of flexibility</strong> to answer on-demand bussiness requirements faster.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building_blocks">Building blocks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To build a system based on event sourcing there&#8217;re a few building blocks worth mentioning:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Events</p>
</li>
<li>
<p>Event Store</p>
</li>
<li>
<p>Event Bus</p>
</li>
<li>
<p>Snapshots</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="events">Events</h3>
<div class="paragraph">
<p>The event is the basic unit of information. An event should have a specific structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Event ID</strong>: a unique id of the event in the system</p>
</li>
<li>
<p><strong>Aggregate ID</strong>: links a set of events in the system</p>
</li>
<li>
<p><strong>Version</strong>: The version field helps determining which is the natural order of events of a given aggregate</p>
</li>
<li>
<p><strong>Type of event</strong>: what represents the event</p>
</li>
<li>
<p><strong>Data</strong>: facts that represents a change in the system</p>
</li>
<li>
<p><strong>MetaData</strong>: (Optional) normally contains security related data</p>
</li>
<li>
<p><strong>Date</strong>: when the event was created</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of different events in a banking system:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. An event store entry example</caption>
<colgroup>
<col style="width: 4.7619%;">
<col style="width: 4.7619%;">
<col style="width: 4.7619%;">
<col style="width: 19.0476%;">
<col style="width: 22.8571%;">
<col style="width: 22.8571%;">
<col style="width: 20.9525%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ID</th>
<th class="tableblock halign-left valign-top">AGREGATE_ID</th>
<th class="tableblock halign-left valign-top">V</th>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">DATA</th>
<th class="tableblock halign-left valign-top">METADATA</th>
<th class="tableblock halign-left valign-top">DATE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EV00001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ACCOUNT_CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"name": "Silvester S."}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"createdBy": "Peter Correlo"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:23:23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EV00002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEPOSIT_MADE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"amount": 20400 }</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"createdBy": "Peter Correlo"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:24:23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EV00003</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITHDRAWAL_MADE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"amount": 300 }</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"createdBy": "Peter Correlo"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:25:23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EV00003</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BANK_COMMISSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"amount": 1 }</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"createdBy": "System"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:26:23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EV00004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG2000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ACCOUNT_CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"name": "Arnold S."}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"createdBy": "Peter Correlo"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:28:23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EV00005</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AGG2000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEPOSIT_MADE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"amount": 10000 }</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"createdBy": "Peter Correlo"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-12-12 10:30:23</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All events have a <strong>different EVENT_ID</strong> but some of them are linked to the same <strong>AGGREGATE_ID</strong>. In this system the aggregate ID represents the account, meaning all these events are applied to a given account.</p>
</div>
<div class="quoteblock">
<blockquote>
In general an aggregate is the link a given set of events are related to
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="event_store">Event store</h3>
<div class="paragraph">
<p>The event store could use any type of storage as long as it is capable of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Appending events</strong></p>
</li>
<li>
<p><strong>Querying those events</strong></p>
</li>
<li>
<p><strong>Notifying of new events</strong> appended.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="appending_events">Appending events</h4>
<div class="paragraph">
<p>As events can&#8217;t be ever modified, they form an endless stream that go forward in time. An even store should be capable of appending new events to that
stream without allowing any update to the stream.</p>
</div>
</div>
<div class="sect3">
<h4 id="querying">Querying</h4>
<div class="paragraph">
<p>Queries should allow the user to restore the system state. Normally the state is rebuild through aggregates, so you should be able to query events by the
aggregate they are linked to. Some examples could be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List all events linked to a given aggregate</p>
</li>
<li>
<p>List all events linked to a given aggregate from a given point in time to another point in time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But you can expand the type of queries to all the attributes we defined earlier for a given event:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List by event type</p>
</li>
<li>
<p>List events between dates</p>
</li>
<li>
<p>&#8230;&#8203; you name it</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="notifying">Notifying</h4>
<div class="paragraph">
<p><span class="image right"><img src="/img/2021/03/event_sourcing/event_bus.png" alt="event_bus" width="30%"></span></p>
</div>
<div class="paragraph">
<p>An event-store can notify to listeners when a new event has been appended to the store. That means that either the event-store has some built-in event-bus or
the event-store can be connected to an event-bus which eventually will dispatch the event to the desired listener.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="event_bus">Event bus</h3>
<div class="paragraph">
<p>One of the features of an event store is to be able to notify of every new event added. This is very useful for other systems
interested in all events or maybe some specific types of events. That can be done with a built-in messaging system or an outside piece of software.</p>
</div>
<div class="paragraph">
<p>A very common component in event-sourcing applications is <a href="https://www.confluent.io/blog/event-sourcing-using-apache-kafka/">Apache Kafka</a>, specially because it can also be used as event-store due to its unique architecture and
features. But there&#8217;re many other projects perfect for sending messages to third party interested listeners. Some examples could be <a href="https://www.rabbitmq.com/">RabbitMQ</a>, <a href="https://nats.io/">NATS.io</a>, <a href="https://pulsar.apache.org/">Pulsar</a> &#8230;&#8203;etc</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="and_many_more">&#8230;&#8203;and many more</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article is just an introduction of some of the most basic definitions regarding event-sourcing. However there are a few other topics worth studying before building any event-sourcing system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hexagonal architecture</p>
</li>
<li>
<p>DDD</p>
</li>
<li>
<p>CQRS</p>
</li>
<li>
<p>Kafka as it&#8217;s very often used as event-store</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.eventstore.com/blog/what-is-event-sourcing" class="bare">https://www.eventstore.com/blog/what-is-event-sourcing</a></p>
</li>
<li>
<p><a href="https://martinfowler.com/eaaDev/EventSourcing.html" class="bare">https://martinfowler.com/eaaDev/EventSourcing.html</a></p>
</li>
<li>
<p><a href="https://kickstarter.engineering/event-sourcing-made-simple-4a2625113224" class="bare">https://kickstarter.engineering/event-sourcing-made-simple-4a2625113224</a></p>
</li>
<li>
<p><a href="https://www.confluent.io/blog/event-sourcing-using-apache-kafka/">Using Apache Kafka for event sourcing</a></p>
</li>
</ul>
</div>
</div>
</div></yieldScaped></section>
                </div>
            </div><div id="sidebar">
                <div class="inner">
                    <!--Menu--><nav id="menu">
                        <header class="major">
                            <h2>Menu</h2>
                        </header><ul>
                            <li>
                                <a href="/index.html">Latests entries</a>
                            </li><li>
                                <a href="/archive.html">Archive</a>
                            </li><li>
                                <a href="/stats.html">Statistics</a>
                            </li><li>
                                <a href="/about.html">About</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div><script src="/js/jquery.min.js"></script>
            <script src="/js/browser.min.js"></script>
            <script src="/js/breakpoints.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/highlight.pack.js"></script>
            <script type="text/javascript">
                
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    
            </script>
        </div>
    </body>
</html>
