<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no"/>
        <title>Working in Progress</title>
        <link rel="stylesheet" href="/css/main.css"/>
        <link rel="stylesheet" href="/css/zenburn.css"/>
        
        
    </head><body class="is-preload">
        <div id="wrapper">
            <div id="main">
                <div class="inner">
                    <header id="header">
                        <a href="/index.html" class="logo">
                            <strong>
                                WORKING IN PROGRESS
                            </strong> - POST
                        </a><ul class="icons">
                            <li>
                                <a href="/feed.xml" class="icon fa-rss">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://twitter.com/marioggar" class="icon fa-twitter">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://github.com/mariogarcia" class="icon fa-github">
                                    <span class="label">
                                        Github
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </header><section><header class="main"><div class="metadata"><em class="fa fa-calendar-o"></em><b>2021-08-10</b></div><h1>Hbase series: Data Model</h1></header><yieldScaped><div class="sect1">
<h2 id="data_model">Data Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>How data is stored in Hbase differs from what we are used to from relational databases. Although terminology is similar the meaning is not. So lets walk through the different pieces of the data model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Table</p>
</li>
<li>
<p>Row</p>
</li>
<li>
<p>Column Family</p>
</li>
<li>
<p>Column qualifier</p>
</li>
<li>
<p>Cell</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <strong>Table</strong> is the top hierarchical aggregation in Hbase. <strong>A table have rows</strong>, and these rows can have the <strong>rowkey</strong>, the <strong>timestamp</strong>, and the data, grouped in what is called <strong>column families</strong>. Finally a <strong>cell</strong> is the unit of storage in HBase consisting of the following fields: row, column family, column qualifier, timestamp, type, MVCC version, and value. The concept of cell is important because introduces the topic of versioning, but lets leave that topic for another day.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/diag-17817cbe9de0d24fc152f352ccc9be1c.png" alt="diag 17817cbe9de0d24fc152f352ccc9be1c" width="820" height="154">
</div>
</div>
<div class="paragraph">
<p>Imagine I&#8217;ve got the information about all taxi trips in Madrid during the past year and I would like to store them in Hbase. I would like to keep the data regarding the trip (price, number of passengers) apart from the data regarding the attributes of the taxi (car brand, taxi driver license number):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Table taxi-trip</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">rowkey</th>
<th class="tableblock halign-left valign-top">timestamp</th>
<th class="tableblock halign-left valign-top">column_family "trip"</th>
<th class="tableblock halign-left valign-top">column_family "taxi"</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mad01"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trip:price="23", trip:passengers="2"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">taxi:brand="ford", taxi:driver="0001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mad02"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trip:price="12", trip:passengers="4"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">taxi:brand="ford", taxi:driver="0010"</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As you can see, trip information is stored in the column family <strong>"trip"</strong> and the taxi information is stored within the <strong>"taxi"</strong> column family. The <strong>"taxi:"or "trip:" prefixes</strong> are called <strong>column qualifiers</strong> and they tell Hbase which column family the data belongs to.</p>
</div>
<div class="paragraph">
<p>Now, in terms of building a query, How would I get the trip price and taxi driver license in those trips where the number of passengers was greater than 2 ? A basic approach could be:</p>
</div>
<div class="listingblock">
<div class="title">dangerous query</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">scan 'taxi-trip', {
    LIMIT =&gt; 10,
    COLUMNS =&gt; ['trip:price', 'taxi:driver'],
    FILTER =&gt; "SingleColumnValueFilter('trip', 'passengers', &gt;=, 'binary:2')"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t worry about the query syntax, that&#8217;s not important for now, the takeaway point here is why this query doesn&#8217;t scale well. That query could work well <em>for a few records</em>, but remember that <strong>the only index available in Hbase is the row key</strong>. If my database has billions of rows, this query will wait forever because <strong>it will do a full scan</strong>. That&#8217;s why it&#8217;s crucial to have a rowkey policy to allow certain queries to be performant. Now I&#8217;ve changed how I&#8217;m writing the rowkey, so that I can use it to narrow down results:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Table taxi-trip</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">rowkey</th>
<th class="tableblock halign-left valign-top">timestamp</th>
<th class="tableblock halign-left valign-top">column_family "trip"</th>
<th class="tableblock halign-left valign-top">column_family "taxi"</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mad20200101-01"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trip:price="23", trip:passengers="2"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">taxi:brand="ford", taxi:driver="0001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mad20200102-02"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trip:price="12", trip:passengers="4"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">taxi:brand="ford", taxi:driver="0010"</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now in my queries I can use the rowkey as a filter, and because it is indexed, Hbase will know which partitions it has to look at to get the data, avoiding a full scan.</p>
</div>
<div class="listingblock">
<div class="title">optimized query</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">scan 'taxi-trip', {
    LIMIT =&gt; 10,
    COLUMNS =&gt; ['trip:price', 'taxi:driver'],
    STARTROW =&gt; "mad202001-01",
    STOPROW =&gt; "mad202001-03",
    FILTER =&gt; "SingleColumnValueFilter('trip', 'passengers', &gt;=, 'binary:2')"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;re at least a couple of row key filters available so you can create a more flexible searches based on rowkeys. But as a joke I would say that&#8230;&#8203; the key in Hbase is the key X)</p>
</div>
<div class="sect2">
<h3 id="resources">Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://hbase.apache.org/book.html#datamodel">Hbase Data Model</a>: Official Hbase documentation about its data model</p>
</li>
<li>
<p><a href="https://www.dezyre.com/article/overview-of-hbase-architecture-and-its-components/295">Hbase architecture</a>: Article describing the different Hbase components.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next">Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="/blog/2021/08/hbase_series_04.html">Query Model</a></p>
</div>
</div>
</div></yieldScaped></section>
                </div>
            </div><div id="sidebar">
                <div class="inner">
                    <!--Menu--><nav id="menu">
                        <header class="major">
                            <h2>Menu</h2>
                        </header><ul>
                            <li>
                                <a href="/index.html">Latests entries</a>
                            </li><li>
                                <a href="/archive.html">Archive</a>
                            </li><li>
                                <a href="/stats.html">Statistics</a>
                            </li><li>
                                <a href="/about.html">About</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div><script src="/js/jquery.min.js"></script>
            <script src="/js/browser.min.js"></script>
            <script src="/js/breakpoints.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/highlight.pack.js"></script>
            <script type="text/javascript">
                
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    
            </script>
        </div>
    </body>
</html>
