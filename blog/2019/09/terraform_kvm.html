<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no"/>
        <title>Working in Progress</title>
        <link rel="stylesheet" href="/css/main.css"/>
        <link rel="stylesheet" href="/css/zenburn.css"/>
        
        
    </head><body class="is-preload">
        <div id="wrapper">
            <div id="main">
                <div class="inner">
                    <header id="header">
                        <a href="/index.html" class="logo">
                            <strong>
                                WORKING IN PROGRESS
                            </strong> - POST
                        </a><ul class="icons">
                            <li>
                                <a href="/feed.xml" class="icon fa-rss">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://twitter.com/marioggar" class="icon fa-twitter">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://github.com/mariogarcia" class="icon fa-github">
                                    <span class="label">
                                        Github
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </header><section><header class="main"><div class="metadata"><em class="fa fa-calendar-o"></em><b>2019-09-11</b></div><h1>Terraform + KVM</h1></header><yieldScaped><div class="sect2">
<h3 id="terraformkvmlibvirt">Terraform/KVM/libvirt</h3>
<div class="paragraph">
<p><a href="https://www.terraform.io/">Terraform</a> is a tool for provisioning,
and managing infrastructure. It describes a given infrastructure
as code, maintains the state of the infrastructure described so
that an administrator can manage it, adding, removing or updating
resources. One of the things I like the most about Hashicorp is that all its
products are one executable binary in Linux. That makes incredibly
easy to start using them. In this case I just had to download the <code>tar.gz</code> file containing
the executable, put the executable in my shell PATH, and checking
that it works just executing in my shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform --version</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.linux-kvm.org/page/Main_Page">KVM</a> or Kernel Virtual Machine is a virtualization environment consisting on a Linux
Kernel module capable of providing a virtualization infrastructure. You have to check how to install KVM in your Linux distribution,
in Fedora 30 is as easy as executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ sudo dnf install @virtualization</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@virtualization</code> alias is just an aggregation of the required
packages to start using KVM in your local machine. You can check
which packages are included by executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ dnf group info virtualization</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://libvirt.org/">Libvirt</a> is a virtualization API, meaning an
API able to interact with different virtualization environments such
as KVM, Xen&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="terraform_libvirt_provider">Terraform libvirt provider</h3>
<div class="paragraph">
<p>Most of the time Terraform is well known for using it in cloud environments such as AWS, Azure,
Alibaba&#8230;&#8203; but the truth is that it has integrations with more than 90 types of environments thanks
to Terraform&#8217;s <a href="https://www.terraform.io/docs/providers/index.html">providers</a>. Unfortunately
among those official providers there&#8217;s none for KVM. But don&#8217;t worry there&#8217;s an amazing project
providing us with the provider we need.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/dmacvicar/terraform-provider-libvirt">Terraform libvirt provider</a> as its Github repository says is: "Terraform provider to provision infrastructure with Linux&#8217;s KVM using libvirt".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Nowadays because Terraform libvirt provider is not an official provider it&#8217;s to be installed manually in your system. The last
release <a href="https://github.com/dmacvicar/terraform-provider-libvirt/releases">has binaries</a> for some Linux distributions. Anyway you can always
<a href="https://github.com/dmacvicar/terraform-provider-libvirt#building-from-source">build it from source</a> and then
<a href="https://github.com/dmacvicar/terraform-provider-libvirt#installing">install the resulting binary</a> which happens to be what I did.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="hello_kvm">Hello KVM</h3>
<div class="paragraph">
<p>The first Terraform file just creates a Debian 10 VM in
my local KVM. The image is a <code>qcow2</code> image file created with
<a href="https://www.packer.io/intro/">Packer</a> another Hashicorp tool
for creating images (not only VMs but also Docker images as well). A simple Terraform template contains <strong>providers</strong> and <strong>resources</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>provider</strong> is an abstraction over the final environment, and</p>
</li>
<li>
<p>A <strong>resource</strong> is a part of the infrastructure we want to create.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">sample structure</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">provider "libvirt" { <i class="conum" data-value="1"></i><b>(1)</b>
    ...
}

resource "libvirt_volume" "os_image" { <i class="conum" data-value="2"></i><b>(2)</b>
    ...
}

resource "libvirt_domain" "new_vm" { <i class="conum" data-value="3"></i><b>(3)</b>
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The provider for dealing with libvirt compatible environments</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A resource representing a volume in a VM</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A resource representing the VM we want to create</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lets see a real example creating a Debian 10 VM in my local KVM
environment.</p>
</div>
<div class="listingblock">
<div class="title">hello_world.tf</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">provider "libvirt" { <i class="conum" data-value="1"></i><b>(1)</b>
  uri = "qemu:///system"
}

resource "libvirt_volume" "os_image" { <i class="conum" data-value="2"></i><b>(2)</b>
  name   = "os_image"
  pool   = "default"
  source = "/home/mario/Development/devops/hashicorp-tools/packer/out/packer-buster"
}

resource "libvirt_domain" "new_vm" { <i class="conum" data-value="3"></i><b>(3)</b>
  name   = "postgres"
  memory = "1024"
  vcpu   = "2"

  disk {
    volume_id = "${libvirt_volume.os_image.id}"
  }

  network_interface {
    hostname = "postgresvm"
  }

  graphics {
    listen_type = "address"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "virtio"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>Declaring the provider</strong>: There provider knows about the underlying infrastructure. In this case, because we&#8217;re creating
VMs in an libvirt compatible environment, we&#8217;re using the libvirt
provider. This time is pointing to my local environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Declaring which image to use</strong>: The base of the VM created in the infrastructure is going to be a Debian 10. The image can be
created in several ways. I&#8217;ve created mine using Hashicorp&#8217;s Packer.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Describing how everything stick together</strong>: Once I&#8217;ve
described the different resources that I&#8217;m going to use, I should
create a domain resource.  The domain glues all the previous resources.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before doing anything we need <strong>to init the project</strong>. This
is required because Terraform checks whether it has the providers
required to accomplish the plan:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform init

Initializing the backend...

Initializing provider plugins...

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, altough is not mandatory, but in order to keep all templates with the
same format I like to pass the formatter. This will format all
Terraform files found in the current directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform fmt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before executing the terraform plan, I can validate the template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform validate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we can execute our plan:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform apply

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # libvirt_domain.new_vm will be created
  + resource "libvirt_domain" "new_vm" {
      + arch        = (known after apply)
      + emulator    = (known after apply)
      + fw_cfg_name = "opt/com.coreos/config"
...
Plan: 2 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value:</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>apply</strong> command shows you the resources it&#8217;s going to
apply and requires from you to confirm before going any
further. Only if you write <strong>yes</strong> will continue. You can then
check that the VM is up and running. I&#8217;d normally open the
Virtual Machine Manager desktop app.</p>
</div>
<div class="imageblock external">
<div class="content">
<a class="image" href="/img/2019/09/terraform_kvm/hello_kvm_running.png" target="_blank" rel="noopener"><img src="/img/2019/09/terraform_kvm/hello_kvm_running.png" alt="hello kvm running" width="550"></a>
</div>
</div>
<div class="paragraph">
<p>At this point Terraform updates the state of your infrastructure so
that if wanted to destroy everything it knows what to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform destroy</code></pre>
</div>
</div>
<div class="paragraph">
<p>After confirming again that you want to destroy your infrastructure
Terraform will take over and destroy it.</p>
</div>
</div>
<div class="sect2">
<h3 id="variables">Variables</h3>
<div class="paragraph">
<p>At some point we may like to reuse our templates. A first step
could be setting some variables in the template and passing their
values when executing the plan. We can change our initial template
and declare some variables:</p>
</div>
<div class="listingblock">
<div class="title">hello_world.tf</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">variable "kvm_destination_uri" {
  type        = string
  description = "kvm instance uri where the vm is going to be deployed"
}

variable "hostname" {
  type        = string
  description = "hostname of the vm"
}

variable "memory" {
  type        = string
  description = "amount of memory"
}

variable "image_path" {
  type        = string
  description = "where is located the qcow2 image"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have declared the variables we can substitue the literals
by the variables. You only have to add the prefix <code>var.</code> and the
name of the variable in the part of the template you want to use it.</p>
</div>
<div class="listingblock">
<div class="title">hello_world.tf</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">provider "libvirt" {
  uri = var.kvm_destination_uri
}

resource "libvirt_volume" "os_image" {
  name   = "os_image"
  pool   = "default"
  source = var.image_path
}

resource "libvirt_domain" "new_vm" {
  name   = var.hostname
  memory = var.memory
  vcpu   = "2"

  disk {
    volume_id = "${libvirt_volume.os_image.id}"
  }

  network_interface {
    hostname = var.hostname
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally you can execute your plan and pass the variables along
with the command. Here for example we would like to create a VM in a remote KVM host.</p>
</div>
<div class="listingblock">
<div class="title">passing variables values to terraform apply</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">[mario@localhost]$ terraform apply \
    -var="kvm_destination_uri=qemu+ssh:root@my.cloud.example.com/system" \
    -var="hostname=firewall" \
    -var="memory=1024" \
    -var="image_path=/tmp/myimage.qcow2"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or writing those key=value in a variables file:</p>
</div>
<div class="listingblock">
<div class="title">hello_world.tfvars</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">kvm_destination_uri="qemu+ssh:root@my.cloud.example.com/system"
hostname="firewall"
memory="1024"
image_path="/tmp/myimage.qcow2"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And pass the file name to the Terraform apply command:</p>
</div>
<div class="listingblock">
<div class="title">passing variables filename to terraform apply</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">terraform apply -var-file=hello_world.tfvars</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t pass the variables to the command line nor
passing a variables file, still Terraform could prompt you to give
it the values for the required variables.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="modules">Modules</h3>
<div class="paragraph">
<p>One step further when reusing our templates is to create modules. A module represents a set of resources and variables that are meant to be used together. The basic structure of a module directory is to have three files: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>main.tf</code>: where the resources are declared</p>
</li>
<li>
<p><code>variables.tf</code>: where the variables are declared</p>
</li>
<li>
<p><code>outputs.tf</code>: where the output variables are declared</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please notice that <code>variables.tf</code> is where the definition of the
variables are declared, not the values, that, again could be
in a different file <code>.tfvars</code>.</p>
</div>
<div class="paragraph">
<p>I&#8217;m creating the following folder structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ditaa" data-lang="ditaa">+---modules
       +-----debian (module)
       |        +-----main.tf
       |        |
       |        +-----variables.tf
       |
       +-----myplan.tf</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>This structure <strong>modules/debian</strong> represents a module called <strong>debian</strong>.</p>
</li>
<li>
<p>The Terraform plan <strong>myplan.tf</strong> will be reusing the <strong>debian</strong> module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to follow using the previous example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Split the previous version of the terraform file <strong>hello_world_variables.tf</strong></p>
</li>
<li>
<p>Put the variables in the <strong>variables.tf</strong></p>
</li>
<li>
<p>Put the resource declaration in the <strong>main.tf</strong>.</p>
</li>
<li>
<p>These two files will be located at <strong>modules/debian</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">variables.tf</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">variable "kvm_destination_uri" {
  type        = string
  description = "kvm instance uri where the vm is going to be deployed"
}

variable "hostname" {
  type        = string
  description = "hostname of the vm"
}

variable "memory" {
  type        = string
  description = "amount of memory"
}

variable "bridge_name" {
  type        = string
  description = "name of the bridge configured in the host"
}

variable "cpu_count" {
  type        = string
  description = "number of cpus used by vm"
}

variable "os_image" {
  type        = string
  description = "name of the vm volume"
}

variable "image_source_path" {
  type        = string
  description = "qcow2 image path"
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">main.tf</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">provider "libvirt" {
  uri = var.kvm_destination_uri
}

resource "libvirt_volume" "os_image" {
  name   = "os_image${var.os_image}"
  pool   = "default"
  source = var.image_source_path
}

resource "libvirt_domain" "new_vm" {
  name   = var.hostname
  memory = var.memory
  vcpu   = var.cpu_count

  disk {
    volume_id = "${libvirt_volume.os_image.id}"
  }

  network_interface {
    hostname = var.hostname
    bridge   = var.bridge_name
  }

  graphics {
    listen_type = "address"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "virtio"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally I can reference the <strong>debian</strong> module in my new plan overriding
any declared variable in the module.</p>
</div>
<div class="listingblock">
<div class="title">myplan.tf</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">module "k8s_master" {
  source = "./debian"

  kvm_destination_uri = "qemu+ssh://maintainer@future/system"
  image_source_path   = pathexpand("~/Development/devops/hashicorp-tools/packer/out/packer-buster")
  hostname            = "k8s_master"
  memory              = "2048"
  cpu_count           = "2"
  bridge_name         = "br0"
  os_image            = "master_volume"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="references">References</h3>
<div class="paragraph">
<p><strong>Terraform</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>I&#8217;d recommend you to start checking the <a href="https://learn.hashicorp.com/terraform/getting-started/install.html">getting started</a> guide</p>
</li>
<li>
<p>Dealing with <a href="https://www.terraform.io/docs/configuration/variables.html">input variables</a></p>
</li>
<li>
<p>How to create <a href="https://www.terraform.io/docs/modules/index.html">modules</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Terraform libvirt provider</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Official repository and docs at <a href="https://github.com/dmacvicar/terraform-provider-libvirt">Github</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>KVM</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.linux-kvm.org/page/Main_Page">KVM site</a></p>
</li>
<li>
<p>Check the Fedora virtualization guide at <a href="https://docs.fedoraproject.org/en-US/quick-docs/getting-started-with-virtualization/">Fedora virtualization guide</a></p>
</li>
<li>
<p><a href="https://www.cyberciti.biz/faq/find-ip-address-of-linux-kvm-guest-virtual-machine/">How to find ip address of Linux KVM guest virtual machine</a></p>
</li>
</ul>
</div>
</div></yieldScaped></section>
                </div>
            </div><div id="sidebar">
                <div class="inner">
                    <!--Menu--><nav id="menu">
                        <header class="major">
                            <h2>Menu</h2>
                        </header><ul>
                            <li>
                                <a href="/index.html">Latests entries</a>
                            </li><li>
                                <a href="/archive.html">Archive</a>
                            </li><li>
                                <a href="/stats.html">Statistics</a>
                            </li><li>
                                <a href="/about.html">About</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div><script src="/js/jquery.min.js"></script>
            <script src="/js/browser.min.js"></script>
            <script src="/js/breakpoints.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/highlight.pack.js"></script>
            <script type="text/javascript">
                
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    
            </script>
        </div>
    </body>
</html>
