<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no"/>
        <title>Working in Progress</title>
        <link rel="stylesheet" href="/css/main.css"/>
        <link rel="stylesheet" href="/css/zenburn.css"/>
        
        
    </head><body class="is-preload">
        <div id="wrapper">
            <div id="main">
                <div class="inner">
                    <header id="header">
                        <a href="/index.html" class="logo">
                            <strong>
                                WORKING IN PROGRESS
                            </strong> - POST
                        </a><ul class="icons">
                            <li>
                                <a href="/feed.xml" class="icon fa-rss">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://twitter.com/marioggar" class="icon fa-twitter">
                                    <span class="label">
                                        Twitter
                                    </span>
                                </a>
                            </li><li>
                                <a href="https://github.com/mariogarcia" class="icon fa-github">
                                    <span class="label">
                                        Github
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </header><section><header class="main"><div class="metadata"><em class="fa fa-calendar-o"></em><b>2018-11-18</b></div><h1>ELISP: testing with ERT</h1></header><yieldScaped><div class="sect1">
<h2 id="intro">Intro</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the past few weeks I&#8217;ve been working on a small project to get used
to elisp programming, and I got to a point when I needed to make sure
I wasn&#8217;t breaking anything in the process. There&#8217;re several solutions
out there but the first I put my hands on was
<a href="https://www.gnu.org/software/emacs/manual/html_node/ert/index.html">ERT</a>.</p>
</div>
<div class="sect2">
<h3 id="what_is_ert">What is ERT ?</h3>
<div class="quoteblock">
<blockquote>
ERT is a tool for automated testing in Emacs Lisp. Its main features
are facilities for defining tests, running them and reporting the
results, and for debugging test failures interactively.
</blockquote>
<div class="attribution">
&#8212; ERT main page
</div>
</div>
</div>
<div class="sect2">
<h3 id="writing_a_buggy_function">Writing a buggy function</h3>
<div class="paragraph">
<p>In order to show how ERT works, I&#8217;m creating a buggy function. The
function is supposed to sort a list of strings in ascending order by
default. But in fact it returns by default the strings in descending
order.</p>
</div>
<div class="listingblock">
<div class="title">sort list tests</div>
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(defun sort-by-string-length (list &amp;optional asc-desc)
  "Sort a LIST of strings by their length.
Apply direction by ASC-DESC value which could be 'asc' or 'desc'."
  (progn
    (fset 'direction
          (if (equal asc-desc "asc") '&gt; '&lt;))
    (sort list (lambda (a b)
                 (direction (length a) (length b))))))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="writing_tests">Writing tests</h3>
<div class="paragraph">
<p>In order to make sure the function does what it claims to do, we
should write a test. An ERT test normally looks like the following:</p>
</div>
<div class="listingblock">
<div class="title">basic form</div>
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(ert-deftest name-of-the-test ()
             (should ...)) ;; assertions</code></pre>
</div>
</div>
<div class="paragraph">
<p>An ERT test uses the macro <code>ert-deftest</code> to declare a new test. Then
it uses <code>should</code> to check assertions results. There&#8217;re more
possibilities other than <code>should</code>: <code>should-not</code> or <code>should-error</code>. I&#8217;m
talking about them a little bit later.</p>
</div>
<div class="listingblock">
<div class="title">sort list tests</div>
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(ert-deftest test-sort-by-default () <i class="conum" data-value="1"></i><b>(1)</b>
  (should
   (equal (sort-by-string-length '("a" "aaa" "aa")) '("a" "aa" "aaa"))))

(ert-deftest test-sort-by-desc () <i class="conum" data-value="2"></i><b>(2)</b>
  (should (equal (sort-by-string-length '("a" "aaa" "aa") "desc") '("aaa" "aa" "a"))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tests default sort (ascending) by string length</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tests descending sort by string length</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="executing_tests">Executing tests</h3>
<div class="paragraph">
<p>You can execute ERT test in different ways, but the one I prefer is
batch execution via command line. Is the one I think I would use in a
CI environmnet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Of course, you will have to install Emacs in your CI environment
in order to be able to execute these tests.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">shell execution</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">emacs -batch -l ert -l /path/to/file_containing_tests.el -f ert-run-tests-batch-and-exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>And because I&#8217;ve made a mistake with the default sorting this is what I got:</p>
</div>
<div class="listingblock">
<div class="title">test output</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">Running 2 tests (2018-11-18 16:08:14+0100)
   passed  1/2  test-sort-by-default
Test test-sort-by-desc backtrace:
...
Test test-sort-by-desc condition:
    (ert-test-failed
     ((should
       (equal
        (sort-by-string-length-ko ... "desc")
        '...))
      :form
      (equal
       ("a" "aa" "aaa") <i class="conum" data-value="1"></i><b>(1)</b>
       ("aaa" "aa" "a")) <i class="conum" data-value="2"></i><b>(2)</b>
      :value nil :explanation
      (list-elt 0
                (arrays-of-different-length 1 3 "a" "aaa" first-mismatch-at 1))))
   FAILED  2/2  test-sort-by-desc

Ran 2 tests, 1 results as expected, 1 unexpected (2018-11-18 16:08:14+0100)

1 unexpected results:
   FAILED  test-sort-by-desc</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expected</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Actual result</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="asserts_with_should">Asserts with should</h3>
<div class="paragraph">
<p>ERT provides different macros to help you make your tests easier to
read and understand. The most common is <code>should</code>.</p>
</div>
<div class="listingblock">
<div class="title">should</div>
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(ert-deftest test-sum-is-commutative ()
  (should (= (+ 1 2) (+ 2 1))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you may want to assert that the result is not what is
expected, for example to assert that the division operation is not
commutative. For that you can use <code>should-not</code>:</p>
</div>
<div class="listingblock">
<div class="title">should-not</div>
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(ert-deftest test-division-not-commutative ()
  (should-not (= (/ 1 2) (/ 2 1))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>And I&#8217;m sure that at some point, you&#8217;ll need to assert that some
function is throwing an error under some circumstances. In that case
you can use <code>should-error</code>:</p>
</div>
<div class="listingblock">
<div class="title">should-error</div>
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(ert-deftest test-error ()
  (should-error
   (signal 'singularity-error nil)
   :type 'singularity-error))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example I&#8217;m checking that the function throws an error and
also that error is of type <strong>'singularity-error</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>:type</code> is optional
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="fixing_function">Fixing function</h3>
<div class="paragraph">
<p>Now it&#8217;s time to do the fix and make the test pass.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">(defun sort-by-string-length (list &amp;optional asc-desc)
  "Sort a LIST of strings by their length.
Apply direction by ASC-DESC value which could be 'asc' or 'desc'."
  (progn
    (fset 'direction
          (if (equal asc-desc "desc")
              '&gt;
            '&lt;))
    (sort list (lambda (a b)
                 (direction (length a) (length b))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running tests again shows the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-elisp" data-lang="elisp">Running 2 tests (2018-11-18 16:38:00+0100)
   passed  1/2  test-sort-by-default
   passed  2/2  test-sort-by-desc

Ran 2 tests, 2 results as expected (2018-11-18 16:38:00+0100)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now everything works as expected</p>
</div>
</div>
<div class="sect2">
<h3 id="resources">Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/mariogarcia/blog/tree/master/sources/2018/11/elisp-ert">Source Code</a></p>
</li>
<li>
<p><a href="https://www.gnu.org/software/emacs/manual/html_node/ert/index.html">ERT main page</a></p>
</li>
<li>
<p><a href="https://www.emacswiki.org/emacs/UnitTesting">EMACS unit testing tools</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></yieldScaped></section>
                </div>
            </div><div id="sidebar">
                <div class="inner">
                    <!--Menu--><nav id="menu">
                        <header class="major">
                            <h2>Menu</h2>
                        </header><ul>
                            <li>
                                <a href="/index.html">Latests entries</a>
                            </li><li>
                                <a href="/archive.html">Archive</a>
                            </li><li>
                                <a href="/about.html">About</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div><script src="/js/jquery.min.js"></script>
            <script src="/js/browser.min.js"></script>
            <script src="/js/breakpoints.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/highlight.pack.js"></script>
            <script type="text/javascript">
                
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    
            </script>
        </div>
    </body>
</html>
